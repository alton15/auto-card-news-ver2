name: Card News Generate

on:
  schedule:
    - cron: '0 */2 * * *'  # 2시간마다
  workflow_dispatch:       # 수동 실행

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -e .
          playwright install chromium
          playwright install-deps chromium

      - name: Restore credentials
        run: |
          mkdir -p ~/.card-news
          echo '${{ secrets.THREADS_TOKEN_JSON }}' > ~/.card-news/threads_token.json
          chmod 600 ~/.card-news/threads_token.json
          if [ -f .data/publish_history.json ]; then
            cp .data/publish_history.json ~/.card-news/publish_history.json
          fi

      - name: Generate and publish
        env:
          NEWS_RSS_FEEDS: "https://en.yna.co.kr/RSS/news.xml,http://rss.joinsmsn.com/news/joins_joongangdaily_news.xml,https://www.soompi.com/feed,https://www.koreaboo.com/feed/"
          NEWS_BRAND_NAME: ${{ secrets.NEWS_BRAND_NAME }}
          NEWS_BRAND_HANDLE: ${{ secrets.NEWS_BRAND_HANDLE }}
          THREADS_USER_ID: ${{ secrets.THREADS_USER_ID }}
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
        run: card-news generate --auto-publish --limit 1

      - name: Save publish history
        run: |
          mkdir -p .data
          cp ~/.card-news/publish_history.json .data/publish_history.json 2>/dev/null || true
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .data/publish_history.json
          git diff --staged --quiet || git commit -m "chore: update publish history [skip ci]" && git push
